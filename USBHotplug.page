Menu="OtherSettings"
Title="USB Hotplug"
---
<?php
$plugin = "usb-hotplug";
$cfg_file = "/boot/config/plugins/$plugin/usb-hotplug.cfg";
$log_file = "/var/log/usb-hotplug.log";

$message = '';

// Detect boot device (replicate monitor script logic)
function detect_boot_device() {
    // Find device mounted at /boot
    $mount_output = shell_exec("mount | grep ' /boot '");
    if (!$mount_output) return null;

    preg_match('/^(\/dev\/[a-z]+)/', $mount_output, $matches);
    if (!$matches) return null;

    $boot_device = basename(preg_replace('/[0-9]+$/', '', $matches[1]));

    // Find USB device matching this block device
    foreach (glob('/sys/bus/usb/devices/*') as $usb_dev) {
        if (!file_exists("$usb_dev/idVendor")) continue;

        foreach (glob('/sys/block/*') as $block) {
            if (!file_exists("$block/device")) continue;

            $block_usb = realpath("$block/device");
            $usb_path = realpath($usb_dev);

            if ($block_usb && $usb_path && strpos($block_usb, $usb_path) === 0) {
                $block_name = basename($block);
                if ($block_name === $boot_device) {
                    $vendor = trim(file_get_contents("$usb_dev/idVendor"));
                    $product = trim(file_get_contents("$usb_dev/idProduct"));
                    return "$vendor:$product";
                }
            }
        }
    }
    return null;
}

// Load blacklisted devices from config file
function load_blacklist($cfg_file) {
    $blacklisted = [];
    if (file_exists($cfg_file)) {
        $lines = file($cfg_file, FILE_IGNORE_NEW_LINES | FILE_SKIP_EMPTY_LINES);
        foreach ($lines as $line) {
            $line = trim($line);
            if (empty($line) || $line[0] === '#') continue;

            // Extract vendor:product ID
            if (preg_match('/^([0-9a-fA-F]{4}:[0-9a-fA-F]{4})/', $line, $matches)) {
                $blacklisted[] = $matches[1];
            }
        }
    }
    return $blacklisted;
}

// Get all devices (connected and disconnected blacklisted)
function get_all_devices($cfg_file) {
    $devices = [];
    $blacklisted = load_blacklist($cfg_file);
    $boot_device_id = detect_boot_device();

    // Scan connected USB devices
    foreach (glob('/sys/bus/usb/devices/*') as $device) {
        $vendor_file = "$device/idVendor";
        $product_file = "$device/idProduct";
        $class_file = "$device/bDeviceClass";

        if (file_exists($vendor_file) && file_exists($product_file)) {
            $vendor = trim(file_get_contents($vendor_file));
            $product = trim(file_get_contents($product_file));
            $class = file_exists($class_file) ? trim(file_get_contents($class_file)) : '';

            $device_id = "$vendor:$product";

            if (isset($devices[$device_id])) continue; // Skip duplicates

            // Get device name from lsusb
            $lsusb_line = shell_exec("lsusb -d $vendor:$product | head -n1");
            preg_match('/: (.+)$/', $lsusb_line, $matches);
            $name = isset($matches[1]) ? trim($matches[1]) : 'Unknown Device';

            $is_hub = ($class === '09');
            $is_boot = ($device_id === $boot_device_id);

            $devices[$device_id] = [
                'name' => $name,
                'connected' => true,
                'protected' => $is_hub || $is_boot,
                'blacklisted' => in_array($device_id, $blacklisted) || $is_hub || $is_boot,
                'protection_reason' => $is_boot ? 'Boot Device' : ($is_hub ? 'USB Hub' : null)
            ];
        }
    }

    // Add disconnected blacklisted devices
    foreach ($blacklisted as $device_id) {
        if (!isset($devices[$device_id])) {
            $devices[$device_id] = [
                'name' => 'Unknown Device',
                'connected' => false,
                'protected' => false,
                'blacklisted' => true,
                'protection_reason' => null
            ];
        }
    }

    return $devices;
}

// Sort devices: protected first, then connected, then disconnected
function sort_devices($devices) {
    uasort($devices, function($a, $b) {
        // Protected devices first
        if ($a['protected'] && !$b['protected']) return -1;
        if (!$a['protected'] && $b['protected']) return 1;

        // Boot device before USB hubs
        if ($a['protected'] && $b['protected']) {
            if ($a['protection_reason'] === 'Boot Device') return -1;
            if ($b['protection_reason'] === 'Boot Device') return 1;
        }

        // Connected before disconnected
        if ($a['connected'] && !$b['connected']) return -1;
        if (!$a['connected'] && $b['connected']) return 1;

        // Alphabetically by name
        return strcasecmp($a['name'], $b['name']);
    });

    return $devices;
}

// Handle form submissions
if ($_SERVER['REQUEST_METHOD'] === 'POST') {
    $action = $_POST['action'] ?? '';

    switch ($action) {
        case 'update_blacklist':
            // Handle AJAX request for checkbox-based blacklist updates
            header('Content-Type: application/json');

            $devices_json = $_POST['devices'] ?? '[]';
            $checked_devices = json_decode($devices_json, true);

            if (!is_array($checked_devices)) {
                echo json_encode(['success' => false, 'error' => 'Invalid device data']);
                exit;
            }

            // Generate config file content
            $content = "";
            foreach ($checked_devices as $device_id) {
                // Validate format
                if (preg_match('/^[0-9a-fA-F]{4}:[0-9a-fA-F]{4}$/', $device_id)) {
                    $content .= "$device_id\n";
                }
            }

            $result = file_put_contents($cfg_file, $content);

            if ($result !== false) {
                // Restart monitor to apply changes
                shell_exec("pkill -f qemu-vm-monitor.sh 2>&1");
                sleep(1);
                shell_exec("nohup /usr/local/sbin/qemu-vm-monitor.sh > /dev/null 2>&1 &");
                echo json_encode(['success' => true]);
            } else {
                echo json_encode(['success' => false, 'error' => 'Failed to write config file']);
            }
            exit;

        case 'restart_monitor':
            shell_exec("pkill -f qemu-vm-monitor.sh 2>&1");
            sleep(1);
            shell_exec("nohup /usr/local/sbin/qemu-vm-monitor.sh > /dev/null 2>&1 &");
            $message = '<div class="message-success">&check; Monitor restarted!</div>';
            break;

        case 'stop_monitor':
            shell_exec("pkill -f qemu-vm-monitor.sh 2>&1");
            $message = '<div class="message-success">&check; Monitor stopped!</div>';
            break;

        case 'clear_log':
            shell_exec("echo '' > $log_file");
            $message = '<div class="message-success">&check; Log cleared!</div>';
            break;
    }
}
?>

<style>
/* Container */
.usb-hotplug-container {
    max-width: 1200px;
    margin: 0 auto;
}

/* Status Box */
.status-box {
    padding: 12px 15px;
    border-radius: 4px;
    margin-bottom: 20px;
    font-weight: 500;
}
.status-running {
    background: rgba(40, 167, 69, 0.15);
    border: 1px solid rgba(40, 167, 69, 0.5);
    color: #28a745;
}
.status-stopped {
    background: rgba(220, 53, 69, 0.15);
    border: 1px solid rgba(220, 53, 69, 0.5);
    color: #dc3545;
}

/* Buttons */
.btn-custom {
    margin-right: 10px;
    margin-bottom: 10px;
}

/* Messages */
.message-success {
    background: rgba(40, 167, 69, 0.15);
    border: 1px solid rgba(40, 167, 69, 0.5);
    color: #28a745;
    padding: 12px 15px;
    margin-bottom: 20px;
    border-radius: 4px;
}
.message-error {
    background: rgba(220, 53, 69, 0.15);
    border: 1px solid rgba(220, 53, 69, 0.5);
    color: #dc3545;
    padding: 12px 15px;
    margin-bottom: 20px;
    border-radius: 4px;
}

/* Help Text */
.help-text {
    opacity: 0.65;
    font-size: 13px;
    margin-top: 8px;
    margin-bottom: 0;
}

/* Device Management Section */
.device-management-section {
    background: rgba(0, 0, 0, 0.15);
    border: 1px solid rgba(255, 255, 255, 0.1);
    padding: 20px;
    border-radius: 4px;
    margin-bottom: 25px;
}

.device-management-list {
    background: rgba(0, 0, 0, 0.2);
    border: 1px solid rgba(255, 255, 255, 0.08);
    border-radius: 4px;
    margin-top: 15px;
    overflow: hidden;
}

/* Device Rows */
.device-row {
    padding: 14px 16px;
    border-bottom: 1px solid rgba(255, 255, 255, 0.08);
    display: flex;
    align-items: center;
    justify-content: space-between;
    transition: background-color 0.15s ease;
}
.device-row:last-child {
    border-bottom: none;
}
.device-row:hover {
    background-color: rgba(255, 140, 0, 0.08);
}
.device-row.protected {
    background-color: rgba(0, 0, 0, 0.15);
}
.device-row.protected:hover {
    background-color: rgba(0, 0, 0, 0.2);
}
.device-row.protected label {
    cursor: not-allowed;
    opacity: 0.65;
}
.device-row.disconnected {
    opacity: 0.55;
    font-style: italic;
}
.device-row.disconnected:hover {
    opacity: 0.7;
}

/* Device Row Label */
.device-row label {
    display: flex;
    align-items: center;
    flex: 1;
    cursor: pointer;
    margin: 0;
}
.device-row input[type="checkbox"] {
    margin-right: 12px;
    cursor: pointer;
    width: 16px;
    height: 16px;
}
.device-row input[type="checkbox"]:disabled {
    opacity: 0.4;
    cursor: not-allowed;
}

/* Device Info */
.device-name {
    flex: 1;
    font-size: 14px;
}
.device-id-span {
    color: #ff8c00;
    font-family: 'Courier New', Consolas, monospace;
    font-size: 12px;
    margin-left: 12px;
    font-weight: 500;
}

/* Badges */
.protection-badge {
    background: #ff8c00;
    color: #fff;
    padding: 3px 10px;
    border-radius: 3px;
    font-size: 10px;
    margin-left: 12px;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.3px;
}
.disconnected-badge {
    background: rgba(128, 128, 128, 0.6);
    color: #fff;
    padding: 3px 10px;
    border-radius: 3px;
    font-size: 10px;
    margin-left: 12px;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.3px;
}

/* Remove Button */
.remove-device-btn {
    background: rgba(220, 53, 69, 0.8);
    color: #fff;
    border: none;
    padding: 6px 10px;
    border-radius: 3px;
    cursor: pointer;
    font-size: 18px;
    margin-left: 12px;
    line-height: 1;
    transition: background-color 0.15s ease;
}
.remove-device-btn:hover {
    background: #dc3545;
}

/* Save Indicator */
.save-indicator {
    position: fixed;
    top: 20px;
    right: 20px;
    background: rgba(40, 167, 69, 0.95);
    color: #fff;
    padding: 12px 20px;
    border-radius: 4px;
    font-weight: 500;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
    z-index: 1000;
    display: none;
}
.save-indicator.error {
    background: rgba(220, 53, 69, 0.95);
}

/* Log Viewer */
.log-viewer {
    background: rgba(0, 0, 0, 0.4);
    color: #d4d4d4;
    padding: 16px;
    border-radius: 4px;
    border: 1px solid rgba(255, 255, 255, 0.08);
    font-family: 'Courier New', Consolas, monospace;
    font-size: 12px;
    max-height: 400px;
    overflow-y: auto;
    white-space: pre-wrap;
    word-wrap: break-word;
    line-height: 1.5;
}
</style>

<div class="usb-hotplug-container">
    <h2>USB Hotplug Configuration</h2>

    <?php echo $message; ?>

    <!-- Monitor Status -->
    <?php
    $monitor_running = shell_exec("pgrep -f qemu-vm-monitor.sh");
    $status_class = $monitor_running ? "status-running" : "status-stopped";
    $status_text = $monitor_running ? "Running (PID: " . trim($monitor_running) . ")" : "Stopped";
    ?>

    <div class="status-box <?= $status_class ?>">
        <strong>Monitor Status:</strong> <?= $status_text ?>
    </div>

    <!-- Control Buttons -->
    <div style="margin-bottom: 20px;">
        <form method="POST" style="display: inline;">
            <input type="hidden" name="action" value="restart_monitor">
            <input type="hidden" name="csrf_token" value="<?= $var['csrf_token'] ?>">
            <button type="submit" class="btn-custom">Restart Monitor</button>
        </form>

        <form method="POST" style="display: inline;">
            <input type="hidden" name="action" value="stop_monitor">
            <input type="hidden" name="csrf_token" value="<?= $var['csrf_token'] ?>">
            <button type="submit" class="btn-custom">Stop Monitor</button>
        </form>

        <form method="POST" style="display: inline;">
            <input type="hidden" name="action" value="clear_log">
            <input type="hidden" name="csrf_token" value="<?= $var['csrf_token'] ?>">
            <button type="submit" class="btn-custom">Clear Log</button>
        </form>

        <button onclick="location.reload();" class="btn-custom">Refresh</button>
    </div>

    <!-- USB Device Management -->
    <div class="device-management-section">
        <h3>USB Device Management</h3>
        <p class="help-text">
            Check devices to add them to the blacklist (prevents automatic attachment to VMs).
            Protected devices (boot drive, USB hubs) cannot be unchecked.
        </p>

        <div class="device-management-list">
<?php
$all_devices = get_all_devices($cfg_file);
$sorted_devices = sort_devices($all_devices);

foreach ($sorted_devices as $device_id => $device) {
    $row_classes = ['device-row'];
    if ($device['protected']) $row_classes[] = 'protected';
    if (!$device['connected']) $row_classes[] = 'disconnected';

    echo '<div class="' . implode(' ', $row_classes) . '">';
    echo '    <label>';
    echo '        <input type="checkbox" ';
    echo '               data-device-id="' . htmlspecialchars($device_id) . '" ';
    if ($device['blacklisted']) echo 'checked ';
    if ($device['protected']) echo 'disabled ';
    echo '               onchange="toggleBlacklist(this)">';
    echo '        <span class="device-name">' . htmlspecialchars($device['name']) . '</span>';
    echo '        <span class="device-id-span">(' . htmlspecialchars($device_id) . ')</span>';

    if ($device['protection_reason']) {
        echo '        <span class="protection-badge">' . htmlspecialchars($device['protection_reason']) . '</span>';
    }

    if (!$device['connected']) {
        echo '        <span class="disconnected-badge">(Disconnected)</span>';
    }

    echo '    </label>';

    if (!$device['connected'] && !$device['protected']) {
        echo '    <button class="remove-device-btn" onclick="removeFromBlacklist(\'' . htmlspecialchars($device_id) . '\')" title="Remove from blacklist">&times;</button>';
    }

    echo '</div>';
}
?>
        </div>
    </div>

    <!-- Log Viewer -->
    <div style="margin-top: 30px;">
        <h3>Recent Log Entries (last 50 lines)</h3>
        <div class="log-viewer">
<?php
if (file_exists($log_file)) {
    $log_content = shell_exec("tail -n 50 $log_file");
    echo htmlspecialchars($log_content);
} else {
    echo "Log file not found or empty.";
}
?>
        </div>
    </div>
</div>

<!-- Save indicator -->
<div id="saveIndicator" class="save-indicator"></div>

<script>
function showMessage(message, type) {
    const indicator = document.getElementById('saveIndicator');
    indicator.textContent = message;
    indicator.className = 'save-indicator';
    if (type === 'error') {
        indicator.classList.add('error');
    }
    indicator.style.display = 'block';

    setTimeout(() => {
        indicator.style.display = 'none';
    }, 3000);
}

function toggleBlacklist(checkbox) {
    showMessage('Saving...', 'info');

    // Collect all checked device IDs (including disabled/protected ones)
    const allCheckboxes = document.querySelectorAll('input[data-device-id]:checked');
    const checkedDevices = Array.from(allCheckboxes).map(cb => cb.dataset.deviceId);

    // Send to server
    const formData = new URLSearchParams();
    formData.append('action', 'update_blacklist');
    formData.append('csrf_token', '<?= $var["csrf_token"] ?>');
    formData.append('devices', JSON.stringify(checkedDevices));

    fetch(window.location.href, {
        method: 'POST',
        headers: {'Content-Type': 'application/x-www-form-urlencoded'},
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showMessage('&check; Blacklist updated and monitor restarted', 'success');
        } else {
            showMessage('✗ Failed to update blacklist: ' + (data.error || 'Unknown error'), 'error');
            // Revert checkbox state
            checkbox.checked = !checkbox.checked;
        }
    })
    .catch(error => {
        showMessage('✗ Network error: ' + error.message, 'error');
        // Revert checkbox state
        checkbox.checked = !checkbox.checked;
    });
}

function removeFromBlacklist(deviceId) {
    if (!confirm('Remove device ' + deviceId + ' from blacklist?')) {
        return;
    }

    showMessage('Removing...', 'info');

    // Collect all checked device IDs except the one being removed
    const allCheckboxes = document.querySelectorAll('input[data-device-id]:checked');
    const checkedDevices = Array.from(allCheckboxes)
        .map(cb => cb.dataset.deviceId)
        .filter(id => id !== deviceId);

    // Send to server
    const formData = new URLSearchParams();
    formData.append('action', 'update_blacklist');
    formData.append('csrf_token', '<?= $var["csrf_token"] ?>');
    formData.append('devices', JSON.stringify(checkedDevices));

    fetch(window.location.href, {
        method: 'POST',
        headers: {'Content-Type': 'application/x-www-form-urlencoded'},
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showMessage('&check; Device removed from blacklist', 'success');
            // Reload page to update UI
            setTimeout(() => location.reload(), 1000);
        } else {
            showMessage('✗ Failed to remove device: ' + (data.error || 'Unknown error'), 'error');
        }
    })
    .catch(error => {
        showMessage('✗ Network error: ' + error.message, 'error');
    });
}
</script>
