Menu="OtherSettings"
Title="USB Hotplug"
---
<?php
$plugin = "usb-hotplug";
$cfg_file = "/boot/config/plugins/$plugin/usb-hotplug.cfg";
$log_file = "/var/log/usb-hotplug.log";

$message = '';

// Handle form submissions
if ($_SERVER['REQUEST_METHOD'] === 'POST') {
    $action = $_POST['action'] ?? '';
    
    switch ($action) {
        case 'save_blacklist':
            $content = $_POST['blacklist_content'] ?? '';
            $result = file_put_contents($cfg_file, $content);
            
            if ($result !== false) {
                // Restart monitor to apply changes
                shell_exec("pkill -f qemu-vm-monitor.sh 2>&1");
                sleep(1);
                shell_exec("nohup /usr/local/sbin/qemu-vm-monitor.sh > /dev/null 2>&1 &");
                $message = '<div style="background: #d4edda; border: 1px solid #c3e6cb; color: #155724; padding: 10px; margin-bottom: 15px; border-radius: 3px;">✓ Blacklist saved and monitor restarted successfully!</div>';
            } else {
                $message = '<div style="background: #f8d7da; border: 1px solid #f5c6cb; color: #721c24; padding: 10px; margin-bottom: 15px; border-radius: 3px;">✗ Failed to save blacklist. Check permissions.</div>';
            }
            break;
            
        case 'restart_monitor':
            shell_exec("pkill -f qemu-vm-monitor.sh 2>&1");
            sleep(1);
            shell_exec("nohup /usr/local/sbin/qemu-vm-monitor.sh > /dev/null 2>&1 &");
            $message = '<div style="background: #d4edda; border: 1px solid #c3e6cb; color: #155724; padding: 10px; margin-bottom: 15px; border-radius: 3px;">✓ Monitor restarted!</div>';
            break;
            
        case 'stop_monitor':
            shell_exec("pkill -f qemu-vm-monitor.sh 2>&1");
            $message = '<div style="background: #d4edda; border: 1px solid #c3e6cb; color: #155724; padding: 10px; margin-bottom: 15px; border-radius: 3px;">✓ Monitor stopped!</div>';
            break;
            
        case 'clear_log':
            shell_exec("echo '' > $log_file");
            $message = '<div style="background: #d4edda; border: 1px solid #c3e6cb; color: #155724; padding: 10px; margin-bottom: 15px; border-radius: 3px;">✓ Log cleared!</div>';
            break;
    }
}
?>

<style>
.usb-hotplug-container {
    max-width: 1200px;
    margin: 0 auto;
}
.blacklist-section {
    background: #f6f6f6;
    padding: 20px;
    border-radius: 5px;
    margin-bottom: 20px;
}
.device-list {
    background: white;
    border: 1px solid #ddd;
    padding: 15px;
    border-radius: 3px;
    margin-top: 10px;
    font-family: monospace;
}
.log-viewer {
    background: #1e1e1e;
    color: #d4d4d4;
    padding: 15px;
    border-radius: 3px;
    font-family: 'Courier New', monospace;
    font-size: 12px;
    max-height: 400px;
    overflow-y: auto;
    white-space: pre-wrap;
    word-wrap: break-word;
}
.status-box {
    padding: 10px;
    border-radius: 3px;
    margin-bottom: 15px;
}
.status-running {
    background: #d4edda;
    border: 1px solid #c3e6cb;
    color: #155724;
}
.status-stopped {
    background: #f8d7da;
    border: 1px solid #f5c6cb;
    color: #721c24;
}
.btn-custom {
    margin-right: 10px;
    margin-bottom: 10px;
}
textarea.blacklist-editor {
    width: 100%;
    height: 200px;
    font-family: 'Courier New', monospace;
    font-size: 13px;
    padding: 10px;
    border: 1px solid #ddd;
    border-radius: 3px;
}
.help-text {
    color: #666;
    font-size: 13px;
    margin-top: 5px;
}
.connected-devices {
    margin-top: 20px;
}
.device-item {
    padding: 8px;
    border-bottom: 1px solid #eee;
}
.device-item:last-child {
    border-bottom: none;
}
.device-id {
    font-weight: bold;
    color: #0066cc;
}
</style>

<div class="usb-hotplug-container">
    <h2>USB Hotplug Configuration</h2>
    
    <?php echo $message; ?>
    
    <!-- Monitor Status -->
    <?php
    $monitor_running = shell_exec("pgrep -f qemu-vm-monitor.sh");
    $status_class = $monitor_running ? "status-running" : "status-stopped";
    $status_text = $monitor_running ? "Running (PID: " . trim($monitor_running) . ")" : "Stopped";
    ?>
    
    <div class="status-box <?= $status_class ?>">
        <strong>Monitor Status:</strong> <?= $status_text ?>
    </div>
    
    <!-- Control Buttons -->
    <div style="margin-bottom: 20px;">
        <form method="POST" style="display: inline;">
            <input type="hidden" name="action" value="restart_monitor">
            <input type="hidden" name="csrf_token" value="<?= $var['csrf_token'] ?>">
            <button type="submit" class="btn-custom">Restart Monitor</button>
        </form>
        
        <form method="POST" style="display: inline;">
            <input type="hidden" name="action" value="stop_monitor">
            <input type="hidden" name="csrf_token" value="<?= $var['csrf_token'] ?>">
            <button type="submit" class="btn-custom">Stop Monitor</button>
        </form>
        
        <form method="POST" style="display: inline;">
            <input type="hidden" name="action" value="clear_log">
            <input type="hidden" name="csrf_token" value="<?= $var['csrf_token'] ?>">
            <button type="submit" class="btn-custom">Clear Log</button>
        </form>
        
        <button onclick="location.reload();" class="btn-custom">Refresh</button>
    </div>
    
    <!-- Blacklist Configuration -->
    <div class="blacklist-section">
        <h3>Device Blacklist</h3>
        <p class="help-text">
            Add USB devices that should NOT be automatically attached to VMs.
            Format: VENDOR_ID:PRODUCT_ID followed by an optional comment.
            USB hubs are automatically excluded.
        </p>
        
        <form method="POST">
            <input type="hidden" name="action" value="save_blacklist">
            <input type="hidden" name="csrf_token" value="<?= $var['csrf_token'] ?>">
            <textarea name="blacklist_content" class="blacklist-editor"><?php
                if (file_exists($cfg_file)) {
                    echo htmlspecialchars(file_get_contents($cfg_file));
                } else {
                    echo "# USB Hotplug Blacklist Configuration\n";
                    echo "# Format: VENDOR_ID:PRODUCT_ID  # Description\n\n";
                    echo "18a5:0302  # Unraid flash drive\n";
                }
            ?></textarea>
            <div style="margin-top: 10px;">
                <button type="submit" class="btn-custom">Save Blacklist</button>
            </div>
        </form>
    </div>
    
    <!-- Connected USB Devices -->
    <div class="connected-devices">
        <h3>Currently Connected USB Devices</h3>
        <div class="device-list">
<?php
$devices = shell_exec("lsusb");
echo htmlspecialchars($devices);
?>
        </div>
        
        <div style="margin-top: 15px;">
            <h4>Detailed Device Information</h4>
            <div class="device-list">
<?php
// Get detailed USB device info
$device_info = [];
foreach (glob('/sys/bus/usb/devices/*') as $device) {
    $vendor_file = "$device/idVendor";
    $product_file = "$device/idProduct";
    $class_file = "$device/bDeviceClass";
    
    if (file_exists($vendor_file) && file_exists($product_file)) {
        $vendor = trim(file_get_contents($vendor_file));
        $product = trim(file_get_contents($product_file));
        $class = file_exists($class_file) ? trim(file_get_contents($class_file)) : 'unknown';
        
        // Get device name from lsusb
        $lsusb_line = shell_exec("lsusb -d $vendor:$product | head -n1");
        preg_match('/: (.+)$/', $lsusb_line, $matches);
        $name = isset($matches[1]) ? trim($matches[1]) : 'Unknown Device';
        
        // Skip hubs
        if ($class == '09') {
            $name .= ' (USB Hub - auto-excluded)';
        }
        
        $device_info[] = [
            'id' => "$vendor:$product",
            'name' => $name,
            'class' => $class
        ];
    }
}

// Remove duplicates and sort
$device_info = array_unique($device_info, SORT_REGULAR);
usort($device_info, function($a, $b) {
    return strcmp($a['id'], $b['id']);
});

foreach ($device_info as $dev) {
    echo "<div class='device-item'>";
    echo "<span class='device-id'>{$dev['id']}</span> - {$dev['name']}";
    echo "</div>";
}
?>
            </div>
            <p class="help-text" style="margin-top: 10px;">
                Copy the device ID (e.g., 18a5:0302) to add it to the blacklist above.
            </p>
        </div>
    </div>
    
    <!-- Log Viewer -->
    <div style="margin-top: 30px;">
        <h3>Recent Log Entries (last 50 lines)</h3>
        <div class="log-viewer">
<?php
if (file_exists($log_file)) {
    $log_content = shell_exec("tail -n 50 $log_file");
    echo htmlspecialchars($log_content);
} else {
    echo "Log file not found or empty.";
}
?>
        </div>
    </div>
</div>
